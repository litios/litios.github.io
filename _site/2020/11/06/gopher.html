<!DOCTYPE html>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  

  <title>
    
      Gopher
    
  </title>

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Gopher" />
<meta name="author" content="David Fernandez" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="@((%/(%%.#..&amp;@&amp;(****@(****//*,, @((%/(%%.#//((((#(@.@((**%(%@** @((%##((((((((((((((@((%.(((%&amp;( ****#%#((((((((((((((((((((((%%((((%&amp; ....((((((((((((#. ,,,#((((%(((%%* **((((((((((((( .,%((((((%%%.......%.% *((((((((((((( #@@ ,((((((%%%%%((#,#%.% @(((((((((((((&amp; /((((((((((%%%@,#%.% @(@*,,,*@((((((@ @((((((((((((((%%%@.% /, ,&amp;((((((((@@@@(((((((((((((((((((((%%%%.... @ @@ ,@(@*,/@%@((((((((((((((((((((((((((%%%... * ,((@% @@@(%((((((((((((((((((((((((((%%%@, ..%. #((((((((((((((((((((((((((((((((((((((%%%/ \$$&amp;%((((((((((((((((((((((((((((((((((((((((%%%@ &amp;%.@&amp;*@(((((((((((((((((((((((((((((((((((%%%* &amp;%.@&amp;*#/*((((((((((((((((((((((((((((((((%%%@( #########((((((((((((((((((((((((((((((#%%%@,, *********(((%@((((((((((((((((((((((((((%&amp;.... .........#*.*,,@((((((((((((((((((%&amp;(((%&amp;((((( .........#*.*,,%.&amp;@(((((((((((%%%%@@((%@...... .........#*.*,,%.&amp;#..@#/@@@@#%@ @((%@" />
<meta property="og:description" content="@((%/(%%.#..&amp;@&amp;(****@(****//*,, @((%/(%%.#//((((#(@.@((**%(%@** @((%##((((((((((((((@((%.(((%&amp;( ****#%#((((((((((((((((((((((%%((((%&amp; ....((((((((((((#. ,,,#((((%(((%%* **((((((((((((( .,%((((((%%%.......%.% *((((((((((((( #@@ ,((((((%%%%%((#,#%.% @(((((((((((((&amp; /((((((((((%%%@,#%.% @(@*,,,*@((((((@ @((((((((((((((%%%@.% /, ,&amp;((((((((@@@@(((((((((((((((((((((%%%%.... @ @@ ,@(@*,/@%@((((((((((((((((((((((((((%%%... * ,((@% @@@(%((((((((((((((((((((((((((%%%@, ..%. #((((((((((((((((((((((((((((((((((((((%%%/ \$$&amp;%((((((((((((((((((((((((((((((((((((((((%%%@ &amp;%.@&amp;*@(((((((((((((((((((((((((((((((((((%%%* &amp;%.@&amp;*#/*((((((((((((((((((((((((((((((((%%%@( #########((((((((((((((((((((((((((((((#%%%@,, *********(((%@((((((((((((((((((((((((((%&amp;.... .........#*.*,,@((((((((((((((((((%&amp;(((%&amp;((((( .........#*.*,,%.&amp;@(((((((((((%%%%@@((%@...... .........#*.*,,%.&amp;#..@#/@@@@#%@ @((%@" />
<link rel="canonical" href="http://0.0.0.0:4000/2020/11/06/gopher.html" />
<meta property="og:url" content="http://0.0.0.0:4000/2020/11/06/gopher.html" />
<meta property="og:site_name" content="Litios Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-06T00:00:00+01:00" />
<script type="application/ld+json">
{"headline":"Gopher","url":"http://0.0.0.0:4000/2020/11/06/gopher.html","datePublished":"2020-11-06T00:00:00+01:00","dateModified":"2020-11-06T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/2020/11/06/gopher.html"},"author":{"@type":"Person","name":"David Fernandez"},"@type":"BlogPosting","description":"@((%/(%%.#..&amp;@&amp;(****@(****//*,, @((%/(%%.#//((((#(@.@((**%(%@** @((%##((((((((((((((@((%.(((%&amp;( ****#%#((((((((((((((((((((((%%((((%&amp; ....((((((((((((#. ,,,#((((%(((%%* **((((((((((((( .,%((((((%%%.......%.% *((((((((((((( #@@ ,((((((%%%%%((#,#%.% @(((((((((((((&amp; /((((((((((%%%@,#%.% @(@*,,,*@((((((@ @((((((((((((((%%%@.% /, ,&amp;((((((((@@@@(((((((((((((((((((((%%%%.... @ @@ ,@(@*,/@%@((((((((((((((((((((((((((%%%... * ,((@% @@@(%((((((((((((((((((((((((((%%%@, ..%. #((((((((((((((((((((((((((((((((((((((%%%/ \\$$&amp;%((((((((((((((((((((((((((((((((((((((((%%%@ &amp;%.@&amp;*@(((((((((((((((((((((((((((((((((((%%%* &amp;%.@&amp;*#/*((((((((((((((((((((((((((((((((%%%@( #########((((((((((((((((((((((((((((((#%%%@,, *********(((%@((((((((((((((((((((((((((%&amp;.... .........#*.*,,@((((((((((((((((((%&amp;(((%&amp;((((( .........#*.*,,%.&amp;@(((((((((((%%%%@@((%@...... .........#*.*,,%.&amp;#..@#/@@@@#%@ @((%@","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Litios Blog" />

  <link rel="shortcut icon" type="image/x-icon" href="/./logo.ico" />
  <link rel="stylesheet" href="http://0.0.0.0:4000/assets/css/main.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
</head>
<body a="light" style="color: #f2f2f2">
    <main class="page-content" aria-label="Content">
        <div class="w">
            <div style="display: flex; justify-content: space-between;">
<a style="font-size: 2em;" href="http://0.0.0.0:4000">..</a>
<span onClick="if (document.body.style.color != 'rgb(242, 242, 242)'){
document.body.style.color = '#f2f2f2'; document.body.style.backgroundColor = '#202324';
} else {
document.body.style.color = 'black'; document.body.style.backgroundColor = 'white';
}
" class="material-icons" style="
    cursor: pointer;
    display:flex;
    flex-direction:column;
    justify-content:end;
    align-items:center;
">visibility</span>
</div>
<br><br><br>
<pre style="font-size: 0.6rem; text-align: center">
                                                                                                
                           @((%/(%%.#..&amp;@&amp;(****@(****//*,,                                      
                           @((%/(%%.#//((((#(@.@((**%(%@**                                      
                           @((%##((((((((((((((@((%.(((%&amp;(                                      
                     ****#%#((((((((((((((((((((((%%((((%&amp;                                      
                     ....((((((((((((#.    ,,,#((((%(((%%*                                      
                     **(((((((((((((          .,%((((((%%%.......%.%                            
                     *(((((((((((((     #@@     ,((((((%%%%%((#,#%.%                            
                     @(((((((((((((&amp;            /((((((((((%%%@,#%.%                            
                     @(@*,,,*@((((((@          @((((((((((((((%%%@.%                            
                    /,        ,&amp;((((((((@@@@(((((((((((((((((((((%%%%....                       
                    @    @@    ,@(@*,/@%@((((((((((((((((((((((((((%%%...                       
                    *          ,((@% @@@(%((((((((((((((((((((((((((%%%@,                       
                    ..%.      #((((((((((((((((((((((((((((((((((((((%%%/                       
                        \$$&amp;%((((((((((((((((((((((((((((((((((((((((%%%@                       
                           &amp;%.@&amp;*@(((((((((((((((((((((((((((((((((((%%%*                       
                           &amp;%.@&amp;*#/*((((((((((((((((((((((((((((((((%%%@(                       
                           #########((((((((((((((((((((((((((((((#%%%@,,                       
                           *********(((%@((((((((((((((((((((((((((%&amp;....                       
                           .........#*.*,,@((((((((((((((((((%&amp;(((%&amp;(((((                       
                           .........#*.*,,%.&amp;@(((((((((((%%%%@@((%@......                       
                           .........#*.*,,%.&amp;#..@#/@@@@#%@                                      
                                                    @((%@                                       
</pre>

<hr />

<p>This was a reversing challenge rated with 500 points in NACTF.
Despite of the hint (about using ghidra with the gotools) I actually used Cutter (thank you guys, awesome work with this tool!) for the challenge.</p>

<p>The instructions said:</p>

<blockquote>
  <p>C is so boring, why not Go give this a try?</p>
</blockquote>

<p>This binary doesn’t come from C code but Go code so things look a little bit different from standard binaries.</p>

<hr />

<p><em>There are probably tons of better ways to do this but this is how I solved. I’m just starting with reversing so if you have any tips I would love to hear them!</em></p>

<hr />

<p>Let’s begin by taking a look at the binary. Even though this is a small binary, we have tons of functions:</p>

<p><img src="/./assets/imgs/gopher-funcs.png" /></p>

<p>But let’s start from the beginning. When we try to find the main function we get 4 hits. The one we are looking for is the one named <code class="language-plaintext highlighter-rouge">sys.main.main</code></p>

<p><img src="/./assets/imgs/graph_main.png" /></p>

<p>The first blocks make the encryption part. They took 2 strings in memory and decoded from hex.</p>

<p><img src="/./assets/imgs/decode.png" /></p>

<p>After that, the program constructs a NewCipher object that later is used in the NewCTR, constructing the final key to which our string is going to be compared.</p>

<p>I’m skipping this part mainly because this is not where we want to look for our solution. This is just how the program creates the final key for comparison.</p>

<p>Now, let’s go for the interesting part. The program asks for input:</p>

<p><img src="/./assets/imgs/scanf.png" /></p>

<p>After that, a call is performed to rsi. If we follow it (in runtime) we can see that the function is the XORKeyStream from the crypto library.</p>

<p><img src="/./assets/imgs/xorfunc.png" /></p>

<p>After that, the result is compared with the key the cypher generated before reading our input in the function ConstantTimeCompare</p>

<p><img src="/./assets/imgs/compare.png" /></p>

<p>Enough static analysis. Let’s run the code.</p>

<p>The program prints <code class="language-plaintext highlighter-rouge">Got a flag for me?</code> and we have to enter some data. I’m going to enter a bunch of ‘A’ and put a breakpoint in the compare function.</p>

<p>We can see that the first thing the function does is to check if the length is equal. Checking the registers we can see that the target length is 0x39 because I entered 0x9 ‘A’s. Nice, now we have the length.</p>

<p><img src="/./assets/imgs/compare-length.png" /></p>

<p>After that, we just have to start from the end and ask how the solution would work. We know that our input is read from STDIN, that it has a length of 0x39 and that it’s XOR with some data and compared with the key. If they match, we got it.</p>

<p><img src="/./assets/imgs/diagram.png" /></p>

<p>So, we have to reverse that proceeding. We just have to grab that final key that is compared with our xor input. With that, the solution is the xor operation of the data that it’s xor with our input and the final key from before.</p>

<p><img src="/./assets/imgs/flag-diagram.png" /></p>

<p>First, let’s grab that target key. Put a breakpoint before the call of the ConstantTimeCompare.</p>

<p>By seeing the ConstantTimeCompare  we can check that the destination data (our key) is in arg_20h which is rsp+0x20 (first small block in the left)</p>

<p><img src="/./assets/imgs/constantcompare.png" /></p>

<p>If we check the stack we can get that address and look at the content with the hexdump view.</p>

<p>(Cool trick, I always have the hexdump unsynced so i can move around without messing with the code. Right click in the window and press the sync/unsync offset)</p>

<p>We know the length is 0x39 so with that information we can get the full key:</p>

<p><img src="/./assets/imgs/firstkey.png" /></p>

<p>The key:</p>

<p><code class="language-plaintext highlighter-rouge">6b17d46be8a1a5ef781dea7af734f73e77caf41c354c9aaddd5d1f40d900001c20e36f1392904f1da2fb7cd3613531c9a177a880996af010b2</code></p>

<p>Now we have to get the xor data. The right way to do it probably would be to put a breakpoint in the <code class="language-plaintext highlighter-rouge">call rsi</code> instruction so we can step into the function and take a look but…this is a CTF so time always matter. We can get the key by xor the result of the function with our input. After the call, we get the result in the stack, in the second position.</p>

<p>So go ahead, start the debugging and send 0x39 chars, whatever you want. I sent ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA’ and set a breakpoint right after the <code class="language-plaintext highlighter-rouge">call rsi</code> instruction.
After that we check the stack, get the address (in my case 0xc0000c60c0) and take a look at the data:</p>

<p><img src="/./assets/imgs/mystringxor.png" /></p>

<p>We can see the XOR output and above, our input. So, the input was <code class="language-plaintext highlighter-rouge">414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141414141</code></p>

<p>the result was <code class="language-plaintext highlighter-rouge">4437f65ecf9b93c64003cf0bd306e91806e781331352e89aaf720174eb721e2909935d0db2b3670396f30fc1720d12ff8b5bb390e840eb1c8e</code></p>

<p>and if we xor them, we get:</p>

<p><code class="language-plaintext highlighter-rouge">576b71f8edad28701428e4a9247a85947a6c0725213a9dbee334035aa335f6848d21c4cf3f22642d7b24e80334c53beca1af2d1a901aa5dcf</code></p>

<p>We have everything ready, now we xor this result with the key we get before and the result is:</p>

<p><code class="language-plaintext highlighter-rouge">6e616374667b7768795f643065735f67306c346e675f3376336e5f7573335f746831735f6162695f75493253527962776b6d5a51306b5a4d7d</code></p>

<p>This is hex so we have to convert it to text and the flag shows up:</p>

<p><code class="language-plaintext highlighter-rouge">nactf{why_d0es_g0l4ng_3v3n_us3_th1s_abi_uI2SRybwkmZQ0kZM}</code></p>


        </div>
    </main>

    
    </body>
</html>